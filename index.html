<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <title>Ultra Skelly Web Controller</title>
  <style>
    :root { --bg:#0b0d10; --panel:#13161b; --muted:#6b7280; --text:#e5e7eb; --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    * { box-sizing: border-box; }
    :root{
      --col-left: 360px;
      --col-mid: 420px;   /* <- wider middle column */
    }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); overflow-x: hidden; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #1f242c; position:sticky; top:0; background:rgba(11,13,16,.8); backdrop-filter: blur(6px); z-index:10; }
    h1 { font-size:18px; margin:0; letter-spacing:.4px; }
    .btn { live:none; border:1px solid #2a3039; background:#151a21; color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; transition:.15s transform, .15s background, .15s border; }
    .btn:hover { background:#1b212a; }
    .btn:active { transform: scale(.98); }
    .btn.primary { border-color:#134e55; background:#07333a; color:#a5f3fc; }
    .btn.primary:hover { background:#0a4048; }
    .btn.danger { border-color:#5d1b1b; background:#2a0f10; color:#fecaca; }
    .btn.xs, .btn.sm { padding:6px 8px; font-size:12px; border-radius:10px; }

    /* Show command code only on hover for query buttons */
    .btn.cmd::after { content: ''; }
    .btn.cmd:hover::after { content: ' (' attr(data-code) ')'; color: var(--muted); }


    /* ======= 3-COLUMN LAYOUT ======= */
    .grid{
      display:grid;
      grid-template-columns: var(--col-left) var(--col-mid) 1fr; /* left | middle | right */
      gap:10px;
      padding:20px;
      align-items: start; /* items flow naturally, no stretching */
    }
    
    /* Column containers */
    .col-left, .col-mid, .col-right {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Legacy area classes for backwards compatibility */
    .area-dev{ grid-column: 1; }
    .area-status{ grid-column: 1; }
    .area-live{ grid-column: 2; }
    .area-transfer{ grid-column: 3; }
    .area-files{ grid-column: 3; }
    .area-log{ grid-column: 3; }

    .move-grid { display:flex; gap:.75rem; align-items:center; }
    .iconToggle { border:2px solid transparent; border-radius:12px; padding:6px; background:transparent; cursor:pointer; opacity:.7 }
    .iconToggle.selected { border-color:var(--accent, #7aa7ff); opacity:1; box-shadow:0 0 0 2px rgba(0,0,0,.04) }
    .iconToggle img { width:42px; height:42px; display:block; }


    .card { background:var(--panel); border:1px solid #1f242c; border-radius:16px; padding:16px; }
    .card h2 { margin:0 0 10px; font-size:14px; color:#9ca3af; text-transform:uppercase; letter-spacing:.12em; }
    label { display:block; font-size:12px; color:#9ca3af; margin:10px 0 6px; }
    input, select, textarea { width:100%; background:#0f1318; color:var(--text); border:1px solid #28303a; border-radius:10px; padding:10px 12px; outline:none; }
    input:focus, select:focus, textarea:focus { border-color:#2dd4bf; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #28303a; color:#a7f3d0; background:#0a2a27; font-size:12px; }
    .muted { color:var(--muted); }
    .log { height:360px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b0f14; border-radius:12px; padding:12px; border:1px solid #1f242c; }
    .log .line { white-space: pre-wrap; word-break: break-word; margin: 0 0 6px; }
    .log .rx { color:#93c5fd; }
    .log .tx { color:#a7f3d0; }
    .log .warn { color:#fbbf24; }
    .small { font-size:12px; }
    .actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .spacer { height:8px; }
    footer { padding: 10px 20px; color:#6b7280; font-size:12px; border-top:1px solid #1f242c; }

    /* Topbar: keep controls compact and pinned to right */
    #btnAdvanced { white-space: nowrap; padding: 8px 10px; }
    .topbar-right { display:flex; align-items:center; gap:8px; margin-left:auto; flex-wrap:nowrap; }
    .menuwrap { position:relative; margin-left:0; }
    .dropdown { position:absolute; right:0; top:38px; background:#0f1318; border:1px solid #28303a; border-radius:12px; min-width:240px; padding:10px; z-index:50; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .dropdown label { display:flex; align-items:center; gap:8px; margin:6px 0; font-size:12px; color:#d1d5db; }
    .dropdown input[type=checkbox] { width:auto; }

    /* Progress */
    .progress { height: 10px; background:#0f1318; border:1px solid #28303a; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0%; background: linear-gradient(90deg, #22d3ee, #10b981); transition: width .15s; }
    .capsule { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px; font-size:12px; color:#a7f3fc; }

    /* Files table */
    .tablewrap { border:1px solid #1f242c; border-radius:12px; overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    thead th { position:sticky; top:0; background:#0f1318; color:#a5b4fc; text-align:left; padding:10px; border-bottom:1px solid #1f242c; }
    tbody td { padding:8px 10px; border-bottom:1px solid #1f242c; }
    tbody tr:hover { background:#0f1216; }

    /* Modals & modals */
    .hidden { display:none !important; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; z-index:9999; padding: 20px; }
    .modal-panel { width:min(820px, 92vw); max-height:calc(100vh - 40px); background:#1b0d0d; border:2px solid #7f1d1d; color:#fecaca; border-radius:16px; padding:22px; box-shadow: 0 20px 60px rgba(0,0,0,.5); overflow-y:auto; }
    .modal-panel h3 { margin:0 0 8px; font-size:22px; color:#fecaca; }
    .modal-panel p { margin:8px 0; line-height:1.5; }
    .modal-actions { display:flex; gap:10px; margin-top:16px; justify-content:flex-end; }
    
    /* Edit modal specific: wider number inputs */
    #editModal input[type="number"] {
      width: 70px;
      min-width: 70px;
      flex: 0 0 70px !important;
    }

    /* Movement icons */
    .iconToggle {
      border:2px solid transparent; border-radius:12px; padding:6px;
      background:transparent; cursor:pointer; opacity:.8; transition:.15s;
    }
    .iconToggle:hover { opacity:1; }
    .iconToggle.selected{
      border-color:#3b82f6;               /* blue-500 border */
      background:rgba(59,130,246,.12);    /* faint blue fill */
      box-shadow:0 0 0 2px rgba(59,130,246,.08);
    }

    /* Light group boxes */
    .light-group {
      border: 1px solid #28303a;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      background: rgba(15, 19, 24, 0.5);
    }
    .light-group h3 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #22d3ee;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }
    
    /* Side-by-side light controls */
    .lights-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    
    /* Compact control rows */
    .compact-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 8px;
    }
    .compact-row label {
      margin: 0;
      font-size: 11px;
      min-width: 75px;
    }
    .compact-row input[type="range"] {
      flex: 1;
      min-width: 0;
    }
    .compact-row input[type="number"] {
      width: 70px;
      flex: 0 0 70px;
    }
    .compact-row input[type="color"] {
      width: 36px;
      height: 32px;
      flex: 0 0 36px;
    }
    .compact-row select {
      flex: 1;
      min-width: 0;
    }
    
    @media (max-width: 600px) {
      .lights-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Segmented control for color scope */
    .seg{display:inline-flex; gap:0}
    .seg-btn{
      padding:.45rem .7rem; border:1px solid #d1d5db; background:#fff;
      font-size:.9rem; border-right:none; cursor:pointer
    }
    .seg-btn:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    .seg-btn:last-child{border-right:1px solid #d1d5db;border-top-right-radius:8px;border-bottom-right-radius:8px}
    .seg-btn.selected{border-color:#3b82f6;background:rgba(59,130,246,.12);color:#1f2937}


    /* Eye previews */
    .eye-thumb { width:22px; height:22px; object-fit:contain; vertical-align:middle; margin-right:6px; image-rendering: crisp-edges; }

    /* Eye pickers */
    .eye-grid { display:grid; grid-template-columns: repeat(6, 36px); gap:8px; margin-top:8px; }
    #apEyeGrid { grid-template-columns: repeat(6, 36px); gap:8px; justify-content:center; } /* 6 per row for the live card */
    .eye-opt { border:1px solid #28303a; background:#0f1318; border-radius:8px; padding:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .eye-opt.selected { outline:2px solid var(--accent); }

    /* Disconnected state: dim + disable most cards except Device and Log */
    body.disconnected .grid .card { opacity:.6; pointer-events:none; }
    body.disconnected .area-dev.card,
    body.disconnected .area-log.card { opacity:1; pointer-events:auto !important; }
    body.disconnected #status { color: var(--err); }

    /* Sliders */
    input[type=range]{ width:100%; }

    /* Responsive fallbacks (stack on narrower screens) */
    @media (max-width:1200px){
      .grid{
        grid-template-columns: 1fr;
      }
    }

        /* === Form + checkbox cleanup === */
    label { line-height: 1.25; }
    input, select, textarea { font-size: 14px; line-height: 1.2; }

    /* Reusable inline checkbox row */
    .checkline{
      display:flex; align-items:center; gap:8px;
      margin-top: 8px;
    }
    .checkline.small { font-size:12px; color:#d1d5db; }
    .checkline input[type="checkbox"]{
      width:18px; height:18px; flex:0 0 auto; accent-color: var(--accent);
      border-radius:4px;
    }
    input[type="checkbox"]:focus-visible{
      outline:2px solid var(--accent); outline-offset:2px;
    }

    /* Utility margins to replace inline style attributes */
    .mt-8 { margin-top: 8px; }
    .mt-10 { margin-top: 10px; }
    .mt-12 { margin-top: 12px; }

    /* Color inputs a bit bigger for finger tapping */
    input[type="color"]{
      width: 44px; height: 36px; padding: 0; border-radius: 8px; border:1px solid #28303a;
    }

    /* Buttons: consistent touch targets */
    .btn{ touch-action: manipulation; }
    @media (pointer:coarse){
      .btn { padding:12px 14px; border-radius:14px; min-height: 40px; }
      input, select, textarea { padding:12px 14px; }
      .iconToggle img { width:48px; height:48px; }
    }

    /* Rows wrap gracefully on small screens */
    .row { flex-wrap: wrap; }

    /* Make the log height adaptive (good on phones) */
    .log { height: clamp(220px, 32vh, 360px); }

    /* Tables: make scroll more obvious on mobile */
    .tablewrap { -webkit-overflow-scrolling: touch; }

    /* Dropdown menu spacing on mobile */
    .dropdown label{ display:flex; align-items:center; gap:8px; }

    /* Modals breathe on small screens */
    .modal-panel { width:min(780px, 94vw); }

    /* Fine-tune the file/live grids for phone widths */
    @media (max-width: 600px){
      :root{ --col-left: 1fr; --col-mid: 1fr; }
      .grid{
        grid-template-columns: 1fr;
        padding: 10px;
        gap: 12px;
      }
      #apEyeGrid{ grid-template-columns: repeat(6, 36px); }
      
      /* Make cards fill width on mobile */
      .card { padding: 12px; border-radius: 12px; }
      
      /* Compact header on mobile */
      header { padding: 12px 10px; flex-wrap: wrap; gap: 8px; }
      h1 { font-size: 16px; }
      
      /* Stack topbar controls on mobile if needed */
      .topbar-right { gap: 6px; }
      .btn { font-size: 13px; padding: 8px 12px; }
      
      /* Make tables scroll horizontally */
      .tablewrap { 
        overflow-x: auto; 
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
      }
      
      /* Adjust actions to wrap better */
      .actions { gap: 6px; }
      
      /* Make filter input responsive */
      #filesFilter { max-width: 100% !important; min-width: 0; flex: 1; }
      
      /* Smaller modal panels on mobile */
      .modal-panel { 
        width: calc(100vw - 20px); 
        max-height: calc(100vh - 20px);
        padding: 16px;
      }
    }
    
    /* Additional breakpoint for tablets and medium screens */
    @media (max-width: 1200px){
      .grid{
        grid-template-columns: 1fr;
      }
      :root{ --col-left: 100%; --col-mid: 100%; }
    }

    /* Fix checkbox baseline weirdness inside ‚ÄúAdvanced‚Äù and others */
    .dropdown input[type="checkbox"],
    #slowModal input[type="checkbox"],
    #riskModal input[type="checkbox"]{
      margin: 0; transform: translateY(0); /* prevents baseline misalignment */
    }

    /* Outline inputs when the chosen name already exists on device */
    .warn-border { border-color: var(--warn) !important; box-shadow: 0 0 0 2px rgba(245,158,11,.18); }

    /* Subcard (used for upcoming features) */
    .subcard{
      border:1px dashed #28303a; background:#0f1216; border-radius:12px; padding:12px;
    }
    .subcard-head{ margin-bottom:6px; color:#c7d2fe; }
    .subcard.upcoming{ opacity:.9; }

    footer {
      display: flex;
      align-items: center;
      gap: 12px;              /* spacing between the two spans */
    }

    footer span:last-child {
      margin-left: auto;      /* shove the last span to the right */
      text-align: right;
    }

    /* optional, keep the link on brand */
    footer a { color: var(--accent); }

  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
</head>
<body>
  <!-- First-load warning -->
  <div id="riskModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="riskTitle">
    <div class="modal-panel">
      <h3 id="riskTitle">‚ö†Ô∏è Proceed at your own risk</h3>
      <p>This tool talks directly to your skeleton over Bluetooth and can send file and control commands. While many features have been tested, there is <strong>NO GUARANTEE</strong> this won‚Äôt misbehave or damage your device. By continuing, you accept all risk.</p>
      <p class="muted">Use a fully charged device, keep the browser tab focused during transfers, and avoid interrupting power.</p>
      <div class="modal-actions">
        <button id="riskCancel" class="btn">Leave page</button>
        <button id="riskAccept" class="btn danger">I understand ‚Äî continue</button>
      </div>
    </div>
  </div>

<!-- Experimental Edit warning -->
<div id="editWarnModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="editWarnTitle">
  <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
    <h3 id="editWarnTitle">Experimental feature</h3>
    <p>Per-file Edit actions are experimental and not all features have been tested. Proceed with caution.</p>
    <div class="modal-actions">
      <button id="editWarnOk" class="btn primary">OK</button>
    </div>
  </div>
</div>


  <!-- Slow upload heads-up -->
  <div id="slowModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="slowTitle">
    <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
      <h3 id="slowTitle">Heads up: File sending can be slow</h3>
      <p>
        Large transfers over Bluetooth can take a while. After the file finishes uploading,
        the device may take a couple minutes before you see the final ‚Äúcomplete‚Äù message. 
        Converting the file can greatly speed up the process.
      </p>
      <p class="muted" style="margin-top:6px">
        Keep this tab focused and avoid disconnecting power during the process.
      </p>
      <label class="small checkline mt-10">
        <input id="slowDontShow" type="checkbox"> Don‚Äôt show this again
      </label>
      <div class="modal-actions">
        <button id="slowCancel" class="btn">Cancel</button>
        <button id="slowOk" class="btn primary">Continue</button>
      </div>
    </div>
</div>

<!-- Long track heads-up -->
<div id="longModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="longTitle">
  <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
    <h3 id="longTitle">Heads up: long audio</h3>
    <p>
      Uploading tracks longer than 30 seconds is experimental and may be unreliable.
      You can still proceed, but results aren‚Äôt guaranteed.
    </p>
    <label class="small checkline" style="margin-top:10px">
      <input id="longDontShow" type="checkbox"> Don‚Äôt show this again
    </label>
    <div class="modal-actions">
      <button id="longOk" class="btn primary">OK</button>
    </div>
  </div>
</div>

  <!-- Edit file modal -->
  <div id="editModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
      <h3 id="editTitle">Edit File</h3>
      
      <div class="row">
        <div style="flex:2">
          <label>File name</label>
          <input id="edName" placeholder="example.mp3" readonly>
        </div>
        <div style="flex:1">
          <label>Serial #</label>
          <input id="edSerial" disabled>
        </div>
        <div style="flex:1">
          <label>Cluster</label>
          <input id="edCluster" type="number" min="0" step="1" readonly>
        </div>
      </div>
      
      <div class="spacer"></div>
      <div class="row" style="align-items:start">
        <div style="flex:2">
          <label>Eye Icon</label>
          <div id="eyeGrid" class="eye-grid" aria-label="Choose eye icon"></div>
        </div>
        <div style="flex:1">
          <label>Movement</label>
          <div id="edMove" class="move-grid" style="gap:0.5rem">
            <button class="iconToggle" data-part="all" title="All" style="padding:4px">
              <img src="images/icon_action1_se.png" alt="All" style="width:32px;height:32px" />
            </button>
            <button class="iconToggle" data-part="head" title="Head" style="padding:4px">
              <img src="images/icon_action2_se.png" alt="Head" style="width:32px;height:32px" />
            </button>
            <button class="iconToggle" data-part="arm" title="Arm" style="padding:4px">
              <img src="images/icon_action3_se.png" alt="Arm" style="width:32px;height:32px" />
            </button>
            <button class="iconToggle" data-part="torso" title="Torso" style="padding:4px">
              <img src="images/icon_action4_se.png" alt="Torso" style="width:32px;height:32px" />
            </button>
          </div>
        </div>
      </div>

    <div class="spacer"></div>
    <label>Lights</label>
    <div class="row">
      <!-- Head Light Group -->
      <div class="light-group" style="flex:1; margin-top:0">
        <h3>Head Light</h3>
        
        <label>Brightness (0‚Äì255)</label>
        <div class="row">
          <input id="edHeadBrightnessRange" type="range" min="0" max="255" value="200" />
          <input id="edHeadBrightness" type="number" min="0" max="255" value="200" />
        </div>

        <div class="spacer"></div>
        <label>Color</label>
        <div class="row">
          <input id="edHeadColorPick" type="color" value="#ff0000" />
          <input id="edHeadR" type="number" min="0" max="255" value="255" />
          <input id="edHeadG" type="number" min="0" max="255" value="0" />
          <input id="edHeadB" type="number" min="0" max="255" value="0" />
          <button class="iconToggle" id="edHeadColorCycle" title="Cycle all colors">
            <img src="images/icon_light_cycle_no.png" alt="Cycle colors" style="width:24px;height:24px" />
          </button>
        </div>

        <div class="spacer"></div>
        <label>Effect Mode</label>
        <select id="edHeadEffectMode" aria-label="Head effect mode">
          <option value="1">Static</option>
          <option value="2">Strobe</option>
          <option value="3">Pulsing</option>
        </select>

        <div class="spacer"></div>
        <div id="edHeadEffectSpeedBlock">
          <label>Effect Speed (0‚Äì255)</label>
          <div class="row">
            <input id="edHeadEffectSpeedRange" type="range" min="0" max="255" value="0" />
            <input id="edHeadEffectSpeed" type="number" min="0" max="255" value="0" />
          </div>
        </div>
      </div>

      <!-- Torso Light Group -->
      <div class="light-group" style="flex:1; margin-top:0">
        <h3>Torso Light</h3>
        
        <label>Brightness (0‚Äì255)</label>
        <div class="row">
          <input id="edTorsoBrightnessRange" type="range" min="0" max="255" value="200" />
          <input id="edTorsoBrightness" type="number" min="0" max="255" value="200" />
        </div>

        <div class="spacer"></div>
        <label>Color</label>
        <div class="row">
          <input id="edTorsoColorPick" type="color" value="#0000ff" />
          <input id="edTorsoR" type="number" min="0" max="255" value="0" />
          <input id="edTorsoG" type="number" min="0" max="255" value="0" />
          <input id="edTorsoB" type="number" min="0" max="255" value="255" />
          <button class="iconToggle" id="edTorsoColorCycle" title="Cycle all colors">
            <img src="images/icon_light_cycle_no.png" alt="Cycle colors" style="width:24px;height:24px" />
          </button>
        </div>

        <div class="spacer"></div>
        <label>Effect Mode</label>
        <select id="edTorsoEffectMode" aria-label="Torso effect mode">
          <option value="1">Static</option>
          <option value="2">Strobe</option>
          <option value="3">Pulsing</option>
        </select>

        <div class="spacer"></div>
        <div id="edTorsoEffectSpeedBlock">
          <label>Effect Speed (0‚Äì255)</label>
          <div class="row">
            <input id="edTorsoEffectSpeedRange" type="range" min="0" max="255" value="0" />
            <input id="edTorsoEffectSpeed" type="number" min="0" max="255" value="0" />
          </div>
        </div>
      </div>
    </div>

      <div class="spacer"></div>
      <label>Upload new file (replace)</label>
      <input id="edUploadFile" type="file" />
      <label class="small checkline mt-8">
        <input id="edChkConvert" type="checkbox" checked>
        Convert to device format (MP3, 8 kHz mono)
      </label>
      <div id="edConvertOpts" class="row hidden" style="align-items:center">
        <select id="edMp3Kbps" aria-label="MP3 bitrate (edit)">
          <option value="16">16 kbps</option>
          <option value="24">24 kbps</option>
          <option value="32" selected>32 kbps</option>
          <option value="64">64 kbps</option>
        </select>
        <span class="small muted">Converts input before uploading.</span>
      </div>

      <div class="actions">
        <button class="btn primary" id="edUploadBtn">Upload & Replace</button>
      </div>
      <div class="capsule">
        <div>Progress: <span id="edProgText">0 / 0</span></div>
        <div id="edProgPct">0%</div>
      </div>
      <div class="progress"><div id="edProgBar" class="bar"></div></div>
      
      <div class="spacer"></div>
      
      <div class="spacer"></div>
      <label>Log</label>
      <div id="edLog" class="log" style="height:180px;" aria-live="polite"></div>
      
      <div class="spacer"></div>
      
      <div class="modal-actions">
        <button id="edDelete" class="btn danger">Delete</button>
        <button id="edApplyAll" class="btn primary">Apply All Settings</button>
        <button id="edClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <header>
    <h1>ü¶¥ Ultra Skelly Web Controller</h1>
    <div class="topbar-right">
      <span id="status" class="pill">‚óè <span>Disconnected</span></span>
      <button class="btn primary" id="btnConnect">Connect</button>
      <button class="btn danger" id="btnDisconnect" disabled>Disconnect</button>
      <div class="menuwrap">
        <button class="btn" id="btnAdvanced">‚öôÔ∏è Advanced ‚ñæ</button>
        <div id="advMenu" class="dropdown hidden" role="menu" aria-label="Advanced options">
          <label><input type="checkbox" id="advRaw"> Show "Raw Command"</label>
          <label><input type="checkbox" id="advFEDC"> Show FEDC keepalives</label>
          <label><input type="checkbox" id="advFileDetails"> Show File List Details</label>
        </div>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT COLUMN -->
    <div class="col-left">
      <!-- Device / Commands -->
      <section class="card area-dev">
        <h2>Device / Commands</h2>

      <label>Filter by name (optional)</label>
      <input id="nameFilter" placeholder="Animated Skelly" value="Animated Skelly" />

      <div class="spacer"></div>
      <div>
        <label>Queries</label>
        <div class="actions">
          <button class="btn cmd" data-q="E0" data-code="E0">Get Device Params</button>
          <button class="btn cmd" data-q="E1" data-code="E1">Get Live Mode</button>
          <button class="btn cmd" data-q="E5" data-code="E5">Get Volume</button>
          <button class="btn cmd" data-q="E6" data-code="E6">Get BT Name</button>
          <button class="btn cmd" data-q="EE" data-code="EE">Get Version</button>
          <button class="btn cmd" data-q="D2" data-code="D2">Get Capacity</button>
          <button class="btn cmd" data-q="D1" data-code="D1">Get File Order</button>
          <button class="btn" id="btnGetAll" style="font-weight: bold; background: #4CAF50;">Get All</button>
        </div>

      </div>

      <!-- Raw Command (advanced) -->
      <div class="spacer"></div>
      <div id="advRawBlock" class="hidden">
        <label>Raw Command (hex after AA+TAG+payload[‚â§8B]+CRC8 auto)</label>
        <div class="row">
          <select id="tag">
            <option value="E0">E0 (Query Device Params)</option>
            <option value="E1">E1 (Query Live Status)</option>
            <option value="E5">E5 (Query Volume)</option>
            <option value="E6">E6 (Query Classic BT Name)</option>
            <option value="EE">EE</option>
            <option value="D0">D0 (Query File List)</option>
            <option value="D1">D1 (Query File Order)</option>
            <option value="D2">D2 (Query Remaining Capacity)</option>
            <option value="FA">FA (Set Volume)</option>
            <option value="FC">FC (Play/Pause)</option>
            <option value="FD">FD (Enable Live Audio)</option>
            <option value="FE">FE</option>
            <option value="F2">F2 (Set Light Effect Mode)</option>
            <option value="F3">F3 (Set Light Brightness)</option>
            <option value="F4">F4 (Set Light RGB+Color Cycle)</option>
            <option value="F5">F5</option>
            <option value="F6">F6 (Set Light Effect Speed)</option>
            <option value="F9">F9 (Set Eye Icon)</option>
            <option value="C0">C0 (Start Data Transfer)</option>
            <option value="C1">C1 (Send Data Chunk)</option>
            <option value="C2">C2 (End Data Transfer)</option>
            <option value="C3">C3 (Commit File Transfer)</option>
            <option value="C4">C4 (Cancel Data Transfer)</option>
            <option value="C6">C6 (Play/Pause File)</option>
            <option value="C7">C7 (Delete File)</option>
            <option value="C8">C8</option>
            <option value="C9">C9</option>
            <option value="CA">CA (Set Movement Action)</option>
            <option value="CB">CB</option>
          </select>
          <input id="payload" placeholder="payload hex (optional)" />
        </div>
        <div class="actions"><button class="btn" id="btnSendRaw">Send</button></div>
        <div class="small muted" style="margin-top:6px">Payload auto-pads to <strong>16 hex chars (8 bytes)</strong> before CRC8 (poly 0x8C).</div>
      </div>
      
      </section>

      <!-- Status -->
      <section class="card area-status">
        <h2>Current Status</h2>
        <div class="row small" style="gap:12px; flex-wrap:wrap">
          <div style="flex:1 1 180px"><div class="muted">Device Name</div><div id="statName">‚Äî</div></div>
          <div style="flex:1 1 120px"><div class="muted">Show Mode</div><div id="statShowMode">‚Äî</div></div>
          <div style="flex:1 1 160px"><div class="muted">Channels</div><div id="statChannels">‚Äî</div></div>
          <div style="flex:1 1 160px"><div class="muted">Classic BT Name</div><div id="statBtName">‚Äî</div></div>
          <div style="flex:1 1 220px"><div class="muted">Capacity</div><div id="statCapacity">‚Äî</div></div>
          <div style="flex:1 1 180px"><div class="muted">File Count</div><div id="statFileCount">‚Äî</div></div>
          <div style="flex:1 1 140px"><div class="muted">File Order</div><div id="statOrder">‚Äî</div></div>
          <div style="flex:1 1 100px"><div class="muted">PIN</div><div id="statPin">‚Äî</div></div>
        </div>
      </section>
    </div>

    <!-- MIDDLE COLUMN -->
    <div class="col-mid">
      <!-- Live Mode -->
      <section class="card area-live">
        <h2>Live Mode</h2>

        <div class="actions">
          <button class="btn" id="btnBT">Enable Live Mode</button>
        </div>

        <!-- Volume -->
        <div class="compact-row">
          <label>Volume</label>
          <input id="volRange" type="range" min="0" max="100" value="50" />
          <input id="vol" type="number" min="0" max="100" value="50" />
        </div>

        <div class="spacer"></div>
        <label>Movement</label>
        <div id="liveMove" class="move-grid">
          <button class="iconToggle" data-part="all"   title="All">
            <img src="images/icon_action1_se.png" alt="All" />
          </button>
          <button class="iconToggle" data-part="head"  title="Head">
            <img src="images/icon_action2_se.png" alt="Head" />
          </button>
          <button class="iconToggle" data-part="arm"   title="Arm">
            <img src="images/icon_action3_se.png" alt="Arm" />
          </button>
          <button class="iconToggle" data-part="torso" title="Torso">
            <img src="images/icon_action4_se.png" alt="Torso" />
          </button>
        </div>

        <div class="spacer"></div>
        <label>Eyes</label>
        <div id="apEyeGrid" class="eye-grid" aria-label="Choose eye icon"></div>

        <!-- Head Light Controls -->
        <div class="light-group">
          <h3>Head Light</h3>
          
          <div class="compact-row">
            <label>Brightness</label>
            <input id="headBrightnessRange" type="range" min="0" max="255" value="200" />
            <input id="headBrightness" type="number" min="0" max="255" value="200" />
          </div>

          <div class="compact-row">
            <label>Color</label>
            <input id="headColorPick" type="color" value="#ff0000" />
            <input id="headR" type="number" min="0" max="255" value="255" />
            <input id="headG" type="number" min="0" max="255" value="0" />
            <input id="headB" type="number" min="0" max="255" value="0" />
          </div>

          <div style="display:flex; align-items:center; gap:6px; margin-top:8px;">
            <button class="iconToggle" id="btnHeadColorCycle" title="Cycle all colors" style="padding:4px;">
              <img src="images/icon_light_cycle_no.png" alt="Cycle colors" style="width:28px;height:28px" />
            </button>
            <span class="small muted">Cycle</span>
          </div>

          <div class="compact-row">
            <label>Effect</label>
            <select id="headEffectMode" aria-label="Head effect mode">
              <option value="1">Static</option>
              <option value="2">Strobe</option>
              <option value="3">Pulsing</option>
            </select>
          </div>

          <div id="headEffectSpeedBlock" class="compact-row hidden">
            <label>Speed</label>
            <input id="headEffectSpeedRange" type="range" min="0" max="255" value="0" />
            <input id="headEffectSpeed" type="number" min="0" max="255" value="0" />
          </div>
        </div>

        <!-- Torso Light Controls -->
        <div class="light-group">
          <h3>Torso Light</h3>
          
          <div class="compact-row">
            <label>Brightness</label>
            <input id="torsoBrightnessRange" type="range" min="0" max="255" value="200" />
            <input id="torsoBrightness" type="number" min="0" max="255" value="200" />
          </div>

          <div class="compact-row">
            <label>Color</label>
            <input id="torsoColorPick" type="color" value="#ff0000" />
            <input id="torsoR" type="number" min="0" max="255" value="255" />
            <input id="torsoG" type="number" min="0" max="255" value="0" />
            <input id="torsoB" type="number" min="0" max="255" value="0" />
          </div>

          <div style="display:flex; align-items:center; gap:6px; margin-top:8px;">
            <button class="iconToggle" id="btnTorsoColorCycle" title="Cycle all colors" style="padding:4px;">
              <img src="images/icon_light_cycle_no.png" alt="Cycle colors" style="width:28px;height:28px" />
            </button>
            <span class="small muted">Cycle</span>
          </div>

          <div class="compact-row">
            <label>Effect</label>
            <select id="torsoEffectMode" aria-label="Torso effect mode">
              <option value="1">Static</option>
              <option value="2">Strobe</option>
              <option value="3">Pulsing</option>
            </select>
          </div>

          <div id="torsoEffectSpeedBlock" class="compact-row hidden">
            <label>Speed</label>
            <input id="torsoEffectSpeedRange" type="range" min="0" max="255" value="0" />
            <input id="torsoEffectSpeed" type="number" min="0" max="255" value="0" />
          </div>
        </div>

      </section>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-right">
      <!-- File Transfer -->
      <section class="card area-transfer">
      <h2>File Transfer</h2>
      <div class="small muted" style="margin:6px 0 10px">
        Once the file has been uploaded you will be able to modify its settings (either here or in the official app).
      </div>
      <label>Choose file</label>
      <input id="fileInput" type="file" />
      <div style="display:flex; align-items:center; gap:16px; margin-top:8px; flex-wrap:wrap">
        <label class="small checkline" style="margin:0">
          <input id="chkConvert" type="checkbox" checked> Convert to device format (MP3, 8 kHz mono)
        </label>
        <label class="small checkline" style="margin:0">
          <input id="chkBitrateOverride" type="checkbox"> Override bitrate
        </label>
        <div id="convertOpts" class="hidden" style="display:flex; align-items:center; gap:8px">
          <select id="mp3Kbps" aria-label="MP3 bitrate">
            <option value="16">16 kbps</option>
            <option value="24">24 kbps</option>
            <option value="32" selected>32 kbps</option>
            <option value="64">64 kbps</option>
          </select>
        </div>
      </div>


      <label>Device filename <span class="small muted">(using an existing filename will replace that file)</span></label>
      <input id="fileName" placeholder="example.mp3" />
      
      <div class="spacer"></div>
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap">
        <label class="small checkline" style="margin:0">
          <input id="chkChunkOverride" type="checkbox"> Override chunk size
        </label>
        <div id="chunkOverrideOpts" class="hidden" style="display:flex; align-items:center; gap:10px; flex:1; min-width:300px">
          <input id="chunkSizeSlider" type="range" min="50" max="500" value="250" step="10" style="flex:1; min-width:150px" />
          <span class="small" style="white-space:nowrap"><span id="chunkSizeValue">250</span> bytes</span>
        </div>
      </div>
      <div class="small muted" style="margin-top:6px">
        ‚ö†Ô∏è If transfers fail frequently, try reducing the chunk size. Larger values may be faster but less reliable.
      </div>

      <div class="spacer"></div>
      <div class="actions">
        <button class="btn primary" id="btnSendFile">Send to Device</button>
        <button class="btn danger" id="btnCancelFile" disabled>Cancel</button>
      </div>
      <div class="capsule">
        <div>Progress: <span id="progText">0 / 0</span></div>
        <div id="progPct">0%</div>
      </div>
      <div class="progress"><div id="progBar" class="bar"></div></div>
      </section>

      <!-- Text to Speech (bottom) -->
      <section class="card area-empty" hidden>
      <h2>Misc Speech Addons</h2>
      <div class="subcard upcoming" aria-disabled="true">
        <div class="subcard-head"><strong>Upcoming:</strong> Text To Speech
        </div>
        <form id="ttsForm" onsubmit="return false;">
          <label for="ttsText">Text</label>
          <textarea id="ttsText" rows="5" placeholder="Type what Skelly should say..."></textarea>
    
          <div class="actions">
            <button class="btn primary" id="btnSendTTS">Send</button>
          </div>
    
          <div class="small muted">TODO: Add effects...</div>
        </form>
      </div>
    
      <div class="spacer"></div>
      <div class="subcard upcoming" aria-disabled="true">
        <div class="subcard-head">
          <strong>Upcoming:</strong> Record custom audio / forward device audio
        </div>
        <p class="small muted">
          Capture mic audio or forward system audio directly to Skelly (work in progress).
        </p>
        <div class="row">
          <button class="btn" disabled>Record from Microphone</button>
          <button class="btn" disabled>Forward Device Audio</button>
        </div>
      </div>
    
      </section>

      <!-- Files on Device -->
      <section class="card area-files">
      <h2>Files on Device</h2>
      <div class="actions">
        <button class="btn" id="btnRefreshFiles">Refresh List</button>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <span class="small muted" id="filesSummary">‚Äî</span>
          <span class="small muted" id="filesLastRefresh"></span>
        </div>
        <input id="filesFilter" placeholder="Filter by name‚Ä¶" style="max-width:200px" />
      </div>
      <div class="spacer"></div>
      <div class="tablewrap">
        <table id="filesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Enabled</th>
              <th>Name</th>
              <th>Head</th>
              <th>Torso</th>
              <th>Movement</th>
              <th>Eye</th>
              <th class="detail-column">Serial</th>
              <th class="detail-column">DB Slot</th>
              <th class="detail-column">Cluster</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      </section>

      <!-- Log -->
      <section class="card area-log">
        <h2>Log</h2>
        <div class="actions">
          <button class="btn xs" id="btnClearLog">Clear</button>
          <label class="small checkline">
            <input type="checkbox" id="chkAutoscroll" checked /> Autoscroll
          </label>
        </div>
        <div id="log" class="log" aria-live="polite"></div>
      </section>
    </div>
  </div>

  <footer>
    <span class="muted">Tip: Requires Chrome/Edge (desktop or Android) over HTTPS. Web Bluetooth isn‚Äôt supported in Firefox on desktop.</span>
    <span class="muted">Source code: 
      <a href="https://github.com/martinecker/SkellyUltra/tree/main/web_skelly" target="_blank" rel="noopener">
        github.com/martinecker/SkellyUltra/tree/main/web_skelly
      </a>
      <div>based on
        <a href="https://github.com/tinkertims/tinkertims.github.io" target="_blank" rel="noopener">
          github.com/tinkertims/tinkertims.github.io
        </a>
      </div>
    </span>
  </footer>

  <!-- Load the app code -->
  <!-- 
    IMPORTANT: Choose ONE script option below:
    
    Option 1 (MODULAR - Best for development with web server):
      - Use with: VS Code Live Server, http-server, localhost, or any web server
      - Benefits: Clean modular code, easier to maintain and debug
      - Does NOT work with file:// protocol (ES6 modules require web server)
      - Files: app-modular.js + js/*.js modules
      
    Option 2 (BUNDLED - Modular code, works everywhere):
      - Use with: file:// protocol (just open index.html) OR web server
      - Benefits: Works without server, keeps modular code organization
      - Build: Run build-bundle.bat to regenerate from modules
      - File: app-bundled.js (auto-generated, do not edit directly)
  -->
  
  <!-- Option 1: Modular version (requires web server) -->
  <!-- <script type="module" src="app-modular.js"></script> -->
  
  <!-- Option 2: Bundled version (modular code, works with file://) -->
  <script src="app-bundled.js"></script>
</body>
</html>
